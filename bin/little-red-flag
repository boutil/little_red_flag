#!/usr/bin/env ruby

require 'little_red_flag'
require 'net/imap'
require 'net/ping'
require 'listen'
require 'sys-proctable'
include Sys

def initiate_idle(server, user, pass)
  server[:imap] = Net::IMAP.new(server[:addr], port: 993, ssl: true)
  server[:imap].authenticate('PLAIN', user, pass)
  server[:imap].examine('INBOX')
  server[:imap].idle do |res|
    sync if %w(EXISTS FETCH).include?(res.name)
  end
end

def close_idle
  server[:imap].idle_done
end

def sync
  `mbsync inboxes; notmuch new`
end

server = { addr: 'imap.gmail.com' }
server[:ping] = Net::Ping::External.new(server[:addr])

listener = Listen.to('/Users/rlue/.mail') do
  break if ProcTable.ps.any? { |p| p.comm =~ /mbsync/ }
  puts 'something happened!'
end
listener.ignore(%r{^\.notmuch(?:/|$)})
listener.start

loop do
  if server[:ping].ping
    # sync
    # initiate_idle(server[:addr])
    puts "I'd totally be syncing+idling right now"
    loop do
      puts "Now I'm going to bed for 5 seconds"
      sleep 5
      break unless server[:ping].ping
    end
    puts "Now I'd be closing the idle connection"
    # close_idle
  else
    puts 'connection down'
    sleep 5
  end
end
